---
title: "Node.js의 동작원"
categories:
    - Server
tags:
    - node.js
    - backend
---

## Node.js란?
- JavaScript를 브라우저 밖에서도 실행시킬 수 있는 JavaScript 런타임
- 싱글 스레드 논블로킹 모델
- 싱글 스레드지만 비동기 I / O 작업을 통해 요청들을 서로 블로킹하지 ❌
- 동시에 많은 요청들을 비동기로 수행함으로써 싱글 스레드일지라도 논블로킹이 가능하다.
- 이벤트 기반으로 동작한다.
    - 이벤트 기반이란? 이벤트가 발생할 때 미리 지정해둔 작업을 처리하는 방식
        -  NodeJS는 이벤트 리스너에 등록해둔 콜백 함수를 실행하는 방식으로 동작한다.
        -  이벤트 루프가 이를 가능하게 해줌.
    
- 클러스트링을 통해 프로세스를 포크하여 멀티 스레드처럼 사용할 수 있다.

## 싱글 스레드 VS 멀티 스레드
### 싱글 스레드
- 프로세스 내에서 하나의 스레드가 하나의 요청만을 수행하는 것 
- 한 번에 여러 요청을 수행할 수 없다.
- 블로킹 모델

### 멀티 스레드
- 스레드 풀에서 실행의 요청만큼 스레드를 매칭하여 작업을 수행하는 것
- 논블로킹 모델

## Node.js의 구조
![image](https://user-images.githubusercontent.com/69573484/139685598-0ef7de92-7d32-4fc7-bedb-cc9c207c7b69.png)

- 내장 라이브러리
- V8 엔진
- libuv
    - Node.js에서 사용하는 비동기 I/O 라이브러리
    - Node.js의 특성인 이벤트 기반, 논 블로킹 I/O 모델들은 모두 libuv 라이브러리에서 구현된다.
    - 콜백 함수들은 libuv 내에 위치한 이벤트 루프에서 관리 및 처리된다.

## 논블로킹 I / O
- Input Output이 관련된 작업(데이터베이스 CRUD, 파일 시스템)등의 블로킹 작업들은 백그라운드에서 수행하고 이를 비동기 콜백 함수로 이벤트 루프에 전달하는 것
- I/O 작업들은 OS 커널 혹은 libuv 내의 스레드 풀에서 담당하게 된다.
- libuv의 스레드풀은 커널이 지원 안하는 작업들을 수행한다.

## 정리
정리하자면 Node.js는 우리가 직접 제어할 수 있는 스레드가 단 한 개이기 때문에 싱글 스레드 기반이라고 부른다.<br>
그렇기 때문에 효율적으로 클라이언트의 요청을 처리하기 위해서는 이 메인 스레드가 블로킹되거나 멈추지 않게 잘 관리해야 한다.
Node.js는 libuv 라이브러리를 통해 이벤트 기반, 논 블로킹 I/O 모델을 구현하고 있다.
메인 스레드를 통해 JavaScript 코드를 처리하다 블로킹 I/O(외부 API 요청, DB read/write, File I/O 등)를 만나게 되면, 이벤트 루프가 해당 작업을 백그라운드로 보내게 된다.
그리고 백그라운드에서 OS 커널이 비동기 작업을 지원해주게 되면 커널 단의 함수를 호출한다.
만일 커널이 지원해주지 않을 경우, Node.js를 실행했을 때 생긴 다른 워크 스레드들이 해당 작업을 수행하고 작업이 끝난 뒤 콜백 함수를 다시 이벤트 큐에 등록한다.
그렇다면 마지막으로 이벤트 루프가 이벤트 큐에 등록된 콜백 함수를 메인 스레드로 올리는 역할을 하게 된다.



이렇게 Node.js는 새로운 스레드를 생성하거나 멀티 스레드를 관리하는 데 필요한 작업(lock)을 수행하지 않아도 되기에 다른 언어에 비해 적은 오버헤드를 가지고 있고, 확장성이 크며 개발하기가 쉽다.
다만 블로킹 때문에 CPU 연산을 많이 요구하는 작업에는 적합하지 않다는 단점을 지니고 있다.